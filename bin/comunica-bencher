#!/bin/bash
# Main bin script for Comunica Bencher

print_usage () {
    echo "Usage: comunica-bencher <action>"
    echo "Actions:"
    echo "  version       Prints the current comunica-bencher version."
    echo "  init          Initializes a new Comunica Bencher experiment."
    echo "  prepare-data  Generates the dataset and queries for an experiment."
    echo "  gen-matrix    Generates a matrix of experiments."
    echo "  run-local     Executes the experiment on the current machine."
    echo "  plot          Generate TiKZ-based graphs."
    echo "  stats         Analyze the results."
    echo "  dief          Generate diefficiency metrics."
    exit 1
}

ensure_initialized() {
    if [[ ! -f .env ]] ; then
        echo "The current directory is not a valid experiment"
        echo "First run 'comunica-bencher init', and try again in the created directory"
        exit 1
    fi
}

ensure_installed_docker() {
    if ! docker --version > /dev/null; then
        echo "Error: This tool requires Docker to be installed."
        exit 1
    fi
}

ensure_installed_docker_compose() {
    if ! docker-compose --version > /dev/null; then
        echo "Error: This tool requires docker-compose to be installed."
        exit 1
    fi
}

# Validate input args
if [[ $# -lt 1 ]] ; then
    echo "Error: Missing script action"
    print_usage
fi

# Execute action
action=$1
remainingargs=${@:2}
lib_dir="$(dirname "${BASH_SOURCE[0]}")/../lib"
case "$action" in
version)
    cat $lib_dir/../VERSION
    ;;
init)
    $lib_dir/init.sh $remainingargs
    ;;
prepare-data)
    ensure_initialized
    ensure_installed_docker
    $lib_dir/prepare-data.sh $remainingargs
    ;;
gen-matrix)
    node $lib_dir/gen-matrix.js $remainingargs
    ;;
run-local)
    ensure_initialized
    ensure_installed_docker
    ensure_installed_docker_compose
    $lib_dir/run-local.sh $remainingargs
    ;;
plot)
    $lib_dir/plot.sh $remainingargs
    ;;
stats)
    $lib_dir/stats.sh $remainingargs
    ;;
dief)
    $lib_dir/dief.sh $remainingargs
    ;;
*)
    echo "Invalid action '$action'"
    print_usage
    ;;
esac
