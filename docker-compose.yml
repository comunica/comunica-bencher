version: '3'
services:
    benchmark:
        image: comunica/sparql-benchmark-runner
        volumes:
        - ${QUERIES}:/tmp/watdiv-10M/
        - ./output/queries.csv:/tmp/output.csv
        command: http://client:80/sparql /tmp/watdiv-10M/ --output /tmp/output.csv --replication ${REPLICATION} --warmup ${WARMUP_ROUNDS}
        depends_on:
        - server
        - server-cache
        - client
    server:
        image: linkeddatafragments/server.js
        ports:
        - "3000:3000"
        volumes:
        - ${SERVER_DATASET}:/data/dataset.hdt
        - ${SERVER_CONFIG}:/tmp/config.json
        command: /tmp/config.json 3000 ${SERVER_WORKERS}
        deploy:
            mode: global
    server-cache:
        image: nginx:stable
        ports:
        - "4000:80"
        volumes:
        - ./input/nginx-default:/etc/nginx/sites-enabled/default:ro
        - ./input/nginx.conf:/etc/nginx/nginx.conf:ro
        - ./output/cache-logs/:/data/log/nginx
        links:
        - server
        deploy:
            mode: global
    client:
        image: ${EXPERIMENT_NAME}-comunica-initialized
        ports:
        - "8080:80"
        entrypoint:
        - node
        - ./bin/http.js
        environment:
            COMUNICA_CONFIG: /tmp/config.json
        command: /tmp/sources.json -p 80 -t ${CLIENT_TIMEOUT} -l info
        links:
            - server
        deploy:
            mode: replicated
            restart_policy:
                condition: none
            replicas: ${CLIENTS}
